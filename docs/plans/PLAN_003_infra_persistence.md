# Implementation Plan: ì¸í”„ë¼ ì˜ì†ì„± êµ¬ì¶• (PostgreSQL)

**Status**: ğŸ”„ In Progress
**Plan ID**: PLAN_003
**Started**: 2026-01-07
**Last Updated**: 2026-01-07
**Estimated Completion**: 2026-01-08

---

**âš ï¸ ì¤‘ìš” ì§€ì¹¨**: ê° í˜ì´ì¦ˆê°€ ì™„ë£Œëœ í›„ì—ëŠ”:
1. âœ… ì™„ë£Œëœ ì‘ì—…ì˜ ì²´í¬ë°•ìŠ¤ë¥¼ ì²´í¬í•˜ì„¸ìš”.
2. ğŸ§ª ëª¨ë“  í’ˆì§ˆ ê²Œì´íŠ¸ ê²€ì¦ ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”.
3. âš ï¸ ëª¨ë“  í’ˆì§ˆ ê²Œì´íŠ¸ í•­ëª©ì´ í†µê³¼í–ˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.
4. ğŸ“… ìœ„ "Last Updated" ë‚ ì§œë¥¼ ì—…ë°ì´íŠ¸í•˜ì„¸ìš”.
5. ğŸ“ Notes ì„¹ì…˜ì— ë°°ìš´ ì ì„ ê¸°ë¡í•˜ì„¸ìš”.
6. â¡ï¸ ê·¸ í›„ì—ë§Œ ë‹¤ìŒ í˜ì´ì¦ˆë¡œ ì§„í–‰í•˜ì„¸ìš”.

â›” **í’ˆì§ˆ ê²Œì´íŠ¸ë¥¼ ê±´ë„ˆë›°ê±°ë‚˜ ì²´í¬ê°€ ì‹¤íŒ¨í•œ ìƒíƒœë¡œ ì§„í–‰í•˜ì§€ ë§ˆì„¸ìš”.**

---

## ğŸ“‹ ê°œìš” (Overview)

### ê¸°ëŠ¥ ì„¤ëª…
Core Domainì—ì„œ ì •ì˜í•œ ë¦¬í¬ì§€í† ë¦¬ ì¸í„°í˜ì´ìŠ¤(`User`, `Token`, `Event`)ë¥¼ êµ¬í˜„í•˜ëŠ” ì¸í”„ë¼ìŠ¤íŠ¸ëŸ­ì²˜ ê³„ì¸µì„ êµ¬ì¶•í•©ë‹ˆë‹¤.
**DO_003** ê²°ì •ì— ë”°ë¼ **PostgreSQL**ì„ ë°ì´í„°ë² ì´ìŠ¤ë¡œ ì‚¬ìš©í•˜ë©°, **SQLAlchemy (Async)**ì™€ **Alembic**ìœ¼ë¡œ ê´€ë¦¬í•©ë‹ˆë‹¤.

### ì„±ê³µ ê¸°ì¤€ (Success Criteria)
- [ ] `docker-compose` í™˜ê²½ì— PostgreSQL ì»¨í…Œì´ë„ˆ ì¶”ê°€ ë° êµ¬ë™ í™•ì¸
- [ ] SQLAlchemy ë¹„ë™ê¸° ì—”ì§„ ì—°ê²° (`postgresql+asyncpg`) ë° ì„¸ì…˜ ì„¤ì • ì™„ë£Œ
- [ ] Alembicì„ í†µí•œ ì´ˆê¸° ìŠ¤í‚¤ë§ˆ(User, Token, Event) ë§ˆì´ê·¸ë ˆì´ì…˜ ì ìš©
- [ ] ë¦¬í¬ì§€í† ë¦¬ ì–´ëŒ‘í„° êµ¬í˜„ì²´ ì‘ì„± ë° í†µí•© í…ŒìŠ¤íŠ¸(Integration Test) 100% í†µê³¼

### ì‚¬ìš©ì ì˜í–¥ (User Impact)
- ë°ì´í„° ì˜ì†ì„± í™•ë³´ë¡œ ì¸í•´ ì„œë²„ ì¬ì‹œì‘ ì‹œì—ë„ ì‚¬ìš©ì ì •ë³´ì™€ ì¼ì • ë°ì´í„°ê°€ ìœ ì§€ë©ë‹ˆë‹¤.
- ë™ì‹œì„± ì²˜ë¦¬ê°€ ê°•í™”ë˜ì–´ ë‹¤ì¤‘ ì‚¬ìš©ì ìš”ì²­ì„ ì•ˆì •ì ìœ¼ë¡œ ì²˜ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

---

## ğŸ—ï¸ ì•„í‚¤í…ì²˜ ê²°ì • (Architecture Decisions)

| ê²°ì • ì‚¬í•­ | ê·¼ê±° | íŠ¸ë ˆì´ë“œì˜¤í”„ |
|----------|-----------|------------|
| **PostgreSQL 15+** | DO_003ì— ë”°ë¥¸ ê²°ì •. ë°ì´í„° ì•ˆì •ì„± ë° í™•ì¥ì„± í™•ë³´ | ì´ˆê¸° ë¦¬ì†ŒìŠ¤ ì‚¬ìš©ëŸ‰ ì¦ê°€ (Dockerë¡œ í•´ê²°) |
| **asyncpg** | ì„±ëŠ¥ì´ ê°€ì¥ ìš°ìˆ˜í•œ Python ë¹„ë™ê¸° ë“œë¼ì´ë²„ | ë¹Œë“œ ì˜ì¡´ì„± ì¡´ì¬ (Docker í™˜ê²½ì—ì„œ ì œì–´ ê°€ëŠ¥) |
| **Pydantic V2** | SQLAlchemy ëª¨ë¸ê³¼ Pydantic ëª¨ë¸ ê°„ì˜ ë³€í™˜ ìµœì í™” | - |

---

## ğŸ“¦ ì˜ì¡´ì„± (Dependencies)

### ì‹œì‘ ì „ í•„ìš” ì‚¬í•­
- [x] PLAN_001 (Docker í™˜ê²½)
- [x] PLAN_002 (Core Domain ì—”í‹°í‹° ë° í¬íŠ¸)
- [x] DO_003 (ì˜ì†ì„± ì „ëµ ê²°ì •)

### ì™¸ë¶€ ì˜ì¡´ì„±
- sqlalchemy: ^2.0
- asyncpg: ^0.29
- alembic: ^1.13
- pytest-asyncio: ^0.23 (Test)

---

## ğŸ§ª í…ŒìŠ¤íŠ¸ ì „ëµ (Test Strategy)

### í…ŒìŠ¤íŠ¸ ì ‘ê·¼ ë°©ì‹
**TDD ì›ì¹™**: í…ŒìŠ¤íŠ¸ë¥¼ **ë¨¼ì €** ì‘ì„±í•˜ê³ , ì´ë¥¼ í†µê³¼ì‹œí‚¤ê¸° ìœ„í•œ êµ¬í˜„ì„ ì§„í–‰í•©ë‹ˆë‹¤.

### í…ŒìŠ¤íŠ¸ í”¼ë¼ë¯¸ë“œ
| í…ŒìŠ¤íŠ¸ ìœ í˜• | ì»¤ë²„ë¦¬ì§€ ëª©í‘œ | ëª©ì  |
|-----------|-----------------|---------|
| **ë‹¨ìœ„ í…ŒìŠ¤íŠ¸** | í•´ë‹¹ ì—†ìŒ | (Core ë¡œì§ì€ PLAN_002ì—ì„œ ì™„ë£Œë¨) |
| **í†µí•© í…ŒìŠ¤íŠ¸** | 100% (ì—°ê²°) | DB ì—°ê²°, ìŠ¤í‚¤ë§ˆ ìƒì„±, CRUD ë™ì‘ ê²€ì¦ |
| **E2E í…ŒìŠ¤íŠ¸** | í•´ë‹¹ ì—†ìŒ | ì´ë²ˆ ë‹¨ê³„ì—ì„œëŠ” ì œì™¸ |

### í…ŒìŠ¤íŠ¸ íŒŒì¼ êµ¬ì¡°
```
tests/
â”œâ”€â”€ integration/
â”‚   â”œâ”€â”€ test_db_connection.py  (Phase 1)
â”‚   â””â”€â”€ test_repositories.py   (Phase 3)
```

### í˜ì´ì¦ˆë³„ ì»¤ë²„ë¦¬ì§€ ìš”êµ¬ì‚¬í•­
- **Phase 1 (DB ì„¤ì •)**: DB ì—°ê²° ì„±ê³µ ì—¬ë¶€ 100% ê²€ì¦
- **Phase 2 (ìŠ¤í‚¤ë§ˆ)**: Alembic ë§ˆì´ê·¸ë ˆì´ì…˜ ì„±ê³µ ì—¬ë¶€ ê²€ì¦
- **Phase 3 (ë¦¬í¬ì§€í† ë¦¬)**: ì–´ëŒ‘í„° CRUD ë¡œì§ 100% ì»¤ë²„ë¦¬ì§€

---

## ğŸš€ êµ¬í˜„ í˜ì´ì¦ˆ (Implementation Phases)

### Phase 1: DB ì¸í”„ë¼ ì„¤ì •
**ëª©í‘œ**: PostgreSQL ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ë° ì• í”Œë¦¬ì¼€ì´ì…˜ ì—°ê²°
**ì˜ˆìƒ ì‹œê°„**: 2ì‹œê°„
**ìƒíƒœ**: âœ… Complete

#### ì‘ì—… (Tasks)

**ğŸ”´ RED: ì‹¤íŒ¨í•˜ëŠ” í…ŒìŠ¤íŠ¸ ë¨¼ì € ì‘ì„±**
- [x] **Test 1.1**: ì—°ê²° í…ŒìŠ¤íŠ¸ ì‘ì„±
  - íŒŒì¼: `tests/integration/test_db_connection.py`
  - ì˜ˆìƒ ê²°ê³¼: DB ì„¤ì • ë° ë“œë¼ì´ë²„ ì˜ì¡´ì„±ì´ ì—†ìœ¼ë¯€ë¡œ ì‹¤íŒ¨
  - ìƒì„¸: `get_db` ì˜ì¡´ì„±ì„ ì‚¬ìš©í•˜ì—¬ `SELECT 1` ì¿¼ë¦¬ ì‹¤í–‰ í…ŒìŠ¤íŠ¸

**ğŸŸ¢ GREEN: í…ŒìŠ¤íŠ¸ í†µê³¼ë¥¼ ìœ„í•œ êµ¬í˜„**
- [x] **Task 1.2**: Docker Compose ì—…ë°ì´íŠ¸
  - íŒŒì¼: `docker-compose.local.yml`, `docker-compose.yml`
  - ëª©í‘œ: `postgres` ì„œë¹„ìŠ¤ ì¶”ê°€ ë° ë³¼ë¥¨ ì˜ì†í™” ì„¤ì •
- [x] **Task 1.3**: ì˜ì¡´ì„± ì¶”ê°€ ë° ì„¤ì •
  - íŒŒì¼: `pyproject.toml`, `.env.local`, `src/infrastructure/db.py`
  - ëª©í‘œ: `asyncpg/sqlalchemy` ì„¤ì¹˜, `AsyncEngine` ë° ì„¸ì…˜ íŒ©í† ë¦¬ êµ¬í˜„

**ğŸ”µ REFACTOR: ì½”ë“œ ê°œì„ **
- [x] **Task 1.4**: ì„¤ì • ìµœì í™”
  - íŒŒì¼: `src/infrastructure/db.py`
  - ëª©í‘œ: ì ì ˆí•œ ì»¤ë„¥ì…˜ í’€ ì„¤ì • í™•ì¸

#### í’ˆì§ˆ ê²Œì´íŠ¸ (Quality Gate) âœ‹

**âš ï¸ ì¤‘ë‹¨: ëª¨ë“  í•­ëª©ì´ í†µê³¼í•˜ê¸° ì „ê¹Œì§€ Phase 2ë¡œ ë„˜ì–´ê°€ì§€ ë§ˆì„¸ìš”**

- [x] **TDD ì¤€ìˆ˜**: Red-Green-Refactor ì‚¬ì´í´ ì¤€ìˆ˜í•¨
- [x] **ë¹Œë“œ**: `docker compose up -d` ì„±ê³µì ìœ¼ë¡œ ì‹¤í–‰ë¨
- [x] **ëª¨ë“  í…ŒìŠ¤íŠ¸ í†µê³¼**: `pytest tests/integration/test_db_connection.py` í†µê³¼
- [x] **ë¦°íŠ¸**: `ruff check .` í†µê³¼

---

### Phase 2: ìŠ¤í‚¤ë§ˆ ë° ë§ˆì´ê·¸ë ˆì´ì…˜
**ëª©í‘œ**: í…Œì´ë¸” ìŠ¤í‚¤ë§ˆ ì •ì˜ ë° ì ìš© (Alembic)
**ì˜ˆìƒ ì‹œê°„**: 2ì‹œê°„
**ìƒíƒœ**: â³ Pending

#### ì‘ì—… (Tasks)

**ğŸ”´ RED: ì‹¤íŒ¨í•˜ëŠ” í…ŒìŠ¤íŠ¸ ë¨¼ì € ì‘ì„±**
- [ ] **Test 2.1**: í…Œì´ë¸” ì¡´ì¬ ì—¬ë¶€ í™•ì¸ (ìˆ˜ë™/ìŠ¤í¬ë¦½íŠ¸)
  - ìƒì„¸: DB ì ‘ì† í›„ `users` í…Œì´ë¸” í™•ì¸ -> ì—†ì–´ì•¼ í•¨

**ğŸŸ¢ GREEN: í…ŒìŠ¤íŠ¸ í†µê³¼ë¥¼ ìœ„í•œ êµ¬í˜„**
- [ ] **Task 2.2**: ORM ëª¨ë¸ ì •ì˜
  - íŒŒì¼: `src/infrastructure/schema.py`
  - ëª©í‘œ: `User`, `Token`, `Event` ì—”í‹°í‹°ë¥¼ SQLAlchemy Base ëª¨ë¸ë¡œ ë§¤í•‘
- [ ] **Task 2.3**: Alembic ì„¤ì •
  - íŒŒì¼: `alembic.ini`, `migrations/env.py`
  - ëª©í‘œ: ë¹„ë™ê¸° ë§ˆì´ê·¸ë ˆì´ì…˜ ì§€ì› ì„¤ì •
- [ ] **Task 2.4**: ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰
  - ëª…ë ¹ì–´: `alembic revision --autogenerate`, `alembic upgrade head`

**ğŸ”µ REFACTOR: ì½”ë“œ ê°œì„ **
- [ ] **Task 2.5**: ë§ˆì´ê·¸ë ˆì´ì…˜ ìŠ¤í¬ë¦½íŠ¸ ê²€í† 
  - íŒŒì¼: `migrations/versions/*.py`
  - ëª©í‘œ: ìƒì„±ëœ SQLì´ ì •í™•í•˜ê³  ê°€ë…ì„± ìˆëŠ”ì§€ í™•ì¸

#### í’ˆì§ˆ ê²Œì´íŠ¸ (Quality Gate) âœ‹

- [ ] **TDD ì¤€ìˆ˜**: ì „í›„ ìŠ¤í‚¤ë§ˆ ìƒíƒœ ê²€ì¦í•¨
- [ ] **ê¸°ëŠ¥ì„±**: `alembic upgrade head` ì—ëŸ¬ ì—†ì´ ì‹¤í–‰ë¨
- [ ] **ê²€ì¦**: Postgresì— `users`, `tokens`, `events` í…Œì´ë¸” ìƒì„±ë¨

---

### Phase 3: ë¦¬í¬ì§€í† ë¦¬ êµ¬í˜„
**ëª©í‘œ**: ë„ë©”ì¸ í¬íŠ¸ êµ¬í˜„ (Adapter)
**ì˜ˆìƒ ì‹œê°„**: 4ì‹œê°„
**ìƒíƒœ**: â³ Pending

#### ì‘ì—… (Tasks)

**ğŸ”´ RED: ì‹¤íŒ¨í•˜ëŠ” í…ŒìŠ¤íŠ¸ ë¨¼ì € ì‘ì„±**
- [ ] **Test 3.1**: ë¦¬í¬ì§€í† ë¦¬ í†µí•© í…ŒìŠ¤íŠ¸ ì‘ì„±
  - íŒŒì¼: `tests/integration/test_repositories.py`
  - ìƒì„¸: ì‹¤ì œ DBë¥¼ ì‚¬ìš©í•˜ì—¬ `save`, `get_by_id`, `is_expired` ë¡œì§ ê²€ì¦
  - ì˜ˆìƒ ê²°ê³¼: êµ¬í˜„ì²´ê°€ ì—†ìœ¼ë¯€ë¡œ ì‹¤íŒ¨ (ImportError ë“±)

**ğŸŸ¢ GREEN: í…ŒìŠ¤íŠ¸ í†µê³¼ë¥¼ ìœ„í•œ êµ¬í˜„**
- [ ] **Task 3.2**: UserRepository êµ¬í˜„
  - íŒŒì¼: `src/infrastructure/persistence/user_repo.py`
- [ ] **Task 3.3**: TokenRepository êµ¬í˜„
  - íŒŒì¼: `src/infrastructure/persistence/token_repo.py`
- [ ] **Task 3.4**: EventRepository êµ¬í˜„
  - íŒŒì¼: `src/infrastructure/persistence/event_repo.py`

**ğŸ”µ REFACTOR: ì½”ë“œ ê°œì„ **
- [ ] **Task 3.5**: ê³µí†µ ë¦¬í¬ì§€í† ë¦¬ íŒ¨í„´
  - ëª©í‘œ: ê°€ëŠ¥í•˜ë‹¤ë©´ ê³µí†µ CRUD ë¡œì§ ì¶”ì¶œ (Mixin í™œìš©)

#### í’ˆì§ˆ ê²Œì´íŠ¸ (Quality Gate) âœ‹

- [ ] **TDD ì¤€ìˆ˜**: í…ŒìŠ¤íŠ¸ ë¨¼ì € ì‘ì„±í•¨
- [ ] **ëª¨ë“  í…ŒìŠ¤íŠ¸ í†µê³¼**: `pytest tests/integration/test_repositories.py` 100% í†µê³¼
- [ ] **ë¦°íŠ¸**: ruff ì—ëŸ¬ ì—†ìŒ

---

## âš ï¸ ìœ„í—˜ í‰ê°€ (Risk Assessment)

| ìœ„í—˜ | ë°œìƒí™•ë¥  | ì˜í–¥ë„ | ì™„í™” ì „ëµ |
|------|-------------|--------|---------------------|
| **DB ì»¨í…Œì´ë„ˆ ì—°ê²° ì‹¤íŒ¨** | ì¤‘ê°„ | ë†’ìŒ | `docker-compose` ì„¤ì • ê²€ì¦ ë° `depends_on` í—¬ìŠ¤ì²´í¬ ì¶”ê°€ |
| **ë¹„ë™ê¸° ë“œë¼ì´ë²„ í˜¸í™˜ì„±** | ë‚®ìŒ | ì¤‘ê°„ | `asyncpg` ë²„ì „ ëª…ì‹œ ë° ìµœì†Œí•œì˜ DB ê¸°ëŠ¥ë§Œ ì´ˆê¸° ì‚¬ìš© |
| **í…ŒìŠ¤íŠ¸ ë°ì´í„° ì˜¤ì—¼** | ë†’ìŒ | ì¤‘ê°„ | í†µí•© í…ŒìŠ¤íŠ¸ ì‹œ `pytest-asyncio` í”½ìŠ¤ì²˜ë¡œ íŠ¸ëœì­ì…˜ ë¡¤ë°± ë³´ì¥ |

---

## ğŸ”„ ë¡¤ë°± ì „ëµ (Rollback Strategy)

### Phase 1 ì‹¤íŒ¨ ì‹œ
**ë³µêµ¬ ì ˆì°¨**:
- ì½”ë“œ ë³€ê²½ ì·¨ì†Œ: `src/infrastructure/db.py`, `docker-compose*.yml`
- ì˜ì¡´ì„± ì œê±°: `poetry remove asyncpg sqlalchemy`
- ì»¨í…Œì´ë„ˆ ì¤‘ì§€: `docker compose down`

### Phase 2 ì‹¤íŒ¨ ì‹œ
**ë³µêµ¬ ì ˆì°¨**:
- ë°ì´í„°ë² ì´ìŠ¤ ë¡¤ë°±: `alembic downgrade base`
- ì½”ë“œ ë³€ê²½ ì·¨ì†Œ: `src/infrastructure/schema.py`, `migrations/`

### Phase 3 ì‹¤íŒ¨ ì‹œ
**ë³µêµ¬ ì ˆì°¨**:
- íŒŒì¼ ì‚­ì œ: `src/infrastructure/persistence/*.py`
- Git ë³€ê²½ì‚¬í•­ íê¸°

---

## ğŸ“Š ì§„í–‰ ìƒí™© ì¶”ì  (Progress Tracking)

### ì™„ë£Œ ìƒíƒœ
- **Phase 1**: â³ 0% | ğŸ”„ 50% | âœ… 100%
- **Phase 2**: â³ 0% | ğŸ”„ 50% | âœ… 100%
- **Phase 3**: â³ 0% | ğŸ”„ 50% | âœ… 100%

**ì „ì²´ ì§„í–‰ë¥ **: 30% ì™„ë£Œ

### ì‹œê°„ ì¶”ì 
| í˜ì´ì¦ˆ | ì˜ˆìƒ ì‹œê°„ | ì‹¤ì œ ì‹œê°„ | ì°¨ì´ |
|-------|-----------|--------|----------|
| Phase 1 | 2ì‹œê°„ | 0.5ì‹œê°„ | -1.5ì‹œê°„ |
| Phase 2 | 2ì‹œê°„ | - | - |
| Phase 3 | 4ì‹œê°„ | - | - |
| **í•©ê³„** | 8ì‹œê°„ | 0.5ì‹œê°„ | - |

---

## ğŸ“ ë…¸íŠ¸ ë° ë°°ìš´ ì  (Notes & Learnings)

### êµ¬í˜„ ë…¸íŠ¸
- (ì‘ì„± ì˜ˆì •)

### ì§ë©´í•œ ì°¨ë‹¨ ìš”ì†Œ (Blockers)
- (ì‘ì„± ì˜ˆì •)

### í–¥í›„ ê°œì„  ì‚¬í•­
- (ì‘ì„± ì˜ˆì •)

---

## ğŸ“š ì°¸ì¡°ë¬¸ì„œ (References)

### ë¬¸ì„œ
- [SQLAlchemy Asyncio Documentation](https://docs.sqlalchemy.org/en/20/orm/extensions/asyncio.html)
- [Alembic Async Tutorial](https://alembic.sqlalchemy.org/en/latest/cookbook.html#using-asyncio-with-alembic)

### ê´€ë ¨ ì´ìŠˆ
- DO_003: Persistence Strategy

---

## âœ… ìµœì¢… ì²´í¬ë¦¬ìŠ¤íŠ¸ (Final Checklist)

**ê³„íšì„ COMPLETEë¡œ í‘œì‹œí•˜ê¸° ì „ì—**:
- [ ] ëª¨ë“  í˜ì´ì¦ˆê°€ ì™„ë£Œë˜ê³  í’ˆì§ˆ ê²Œì´íŠ¸ë¥¼ í†µê³¼í–ˆìŒ
- [ ] ì „ì²´ í†µí•© í…ŒìŠ¤íŠ¸ ìˆ˜í–‰ë¨
- [ ] ë¬¸ì„œ ì—…ë°ì´íŠ¸ë¨
- [ ] ë³´ì•ˆ ê²€í†  ì™„ë£Œë¨ (DB ìê²©ì¦ëª… ì•ˆì „)
- [ ] ê³„íšì„œ ë¬¸ì„œê°€ ë³´ê´€ë¨
