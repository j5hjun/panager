# Software Requirements Specification (SRS)
# 자율 판단 AI 에이전트 "패니저" v3.0

---

**문서 정보**

| 항목 | 내용 |
|------|------|
| **문서 번호** | SRS-PANAGER-2026-002 |
| **버전** | 2.0.0 |
| **작성일** | 2026-01-03 |
| **최종 수정일** | 2026-01-06 |
| **작성자** | 개발팀 |
| **승인자** | - |
| **문서 상태** | Draft |

---

## 문서 변경 이력

| 버전 | 날짜 | 작성자 | 변경 내용 |
|------|------|--------|----------|
| 0.1.0 | 2026-01-03 | 개발팀 | 초안 작성 |
| 1.0.0 | 2026-01-03 | 개발팀 | v2.0 최초 릴리스 |
| 2.0.0 | 2026-01-06 | 개발팀 | v3.0 이벤트 기반 아키텍처로 전면 개편 |

---

## 목차

1. [서론 (Introduction)](#1-서론-introduction)
   1. [목적 (Purpose)](#11-목적-purpose)
   2. [범위 (Scope)](#12-범위-scope)
   3. [정의, 약어 및 용어 (Definitions, Acronyms, and Abbreviations)](#13-정의-약어-및-용어)
   4. [참고 문서 (References)](#14-참고-문서-references)
   5. [개요 (Overview)](#15-개요-overview)
2. [전체 설명 (Overall Description)](#2-전체-설명-overall-description)
   1. [제품 관점 (Product Perspective)](#21-제품-관점-product-perspective)
   2. [제품 기능 요약 (Product Functions)](#22-제품-기능-요약-product-functions)
   3. [사용자 특성 (User Characteristics)](#23-사용자-특성-user-characteristics)
   4. [제약사항 (Constraints)](#24-제약사항-constraints)
   5. [가정 및 의존성 (Assumptions and Dependencies)](#25-가정-및-의존성-assumptions-and-dependencies)
3. [상세 요구사항 (Specific Requirements)](#3-상세-요구사항-specific-requirements)
   1. [외부 인터페이스 요구사항 (External Interface Requirements)](#31-외부-인터페이스-요구사항)
   2. [기능 요구사항 (Functional Requirements)](#32-기능-요구사항-functional-requirements)
   3. [비기능 요구사항 (Non-Functional Requirements)](#33-비기능-요구사항-non-functional-requirements)
   4. [시스템 속성 (System Attributes)](#34-시스템-속성-system-attributes)
4. [검증 (Verification)](#4-검증-verification)
5. [부록 (Appendices)](#5-부록-appendices)

---

# 1. 서론 (Introduction)

## 1.1 목적 (Purpose)

본 문서는 **자율 판단 AI 에이전트 "패니저(Panager)" v3.0**의 소프트웨어 요구사항을 정의합니다.

### 1.1.1 문서 목적

- 시스템의 기능적/비기능적 요구사항을 명확히 정의
- 개발, 테스트, 검증의 기준 문서로 활용
- 이해관계자 간 요구사항에 대한 합의 도출
- 프로젝트 범위 관리 및 변경 통제의 기준

### 1.1.2 대상 독자

| 역할 | 문서 활용 목적 |
|------|---------------|
| 개발자 | 시스템 구현 가이드 |
| 테스터 | 테스트 케이스 도출 기준 |
| 프로젝트 관리자 | 범위 및 일정 관리 |
| 운영자 | 시스템 운영 요건 파악 |

---

## 1.2 범위 (Scope)

### 1.2.1 제품명

**패니저 (Panager)** - Proactive AI Manager

### 1.2.2 제품 버전

- **v1.0**: Rule-based (고정 규칙 기반)
- **v2.0**: Autonomous Agent (폴링 기반 자율 판단)
- **v3.0**: Event-driven (이벤트 기반 자율 판단) ← **현재**

### 1.2.3 제품 설명

패니저는 사용자가 요청하기 전에 **스스로 상황을 판단하고 필요한 정보를 먼저 제공**하는 능동적 AI 비서입니다.

### 1.2.4 제품 목표

1. **완전 자율 판단**: 고정된 규칙 없이 LLM 기반으로 상황에 맞는 행동 결정
2. **학습 및 개선**: 과거 실수로부터 학습하여 같은 실수 반복 방지
3. **무료 운영**: Groq 무료 tier를 활용한 비용 제로 운영
4. **확장 가능**: 새로운 기능(도구)을 쉽게 추가할 수 있는 구조

### 1.2.5 범위 내 기능 (In Scope)

| ID | 기능 | 설명 |
|----|------|------|
| SC-001 | 자율 판단 루프 | LLM 기반 상황 판단 및 행동 결정 |
| SC-002 | 반성 및 학습 | 행동 결과 분석 및 교훈 저장 |
| SC-003 | 날씨 정보 제공 | 날씨 조회 및 우산 필요 여부 판단 |
| SC-004 | 일정 관리 | 일정 조회, 등록, 리마인더 |
| SC-005 | 길찾기 정보 | 경로 안내 및 출발 시간 계산 |
| SC-006 | Slack 통합 | Slack을 통한 양방향 대화 및 알림 |
| SC-007 | 메모리 시스템 | 대화 기록, 판단 이력, 학습 교훈 저장 |

### 1.2.6 범위 외 기능 (Out of Scope)

| ID | 기능 | 제외 사유 |
|----|------|----------|
| OS-001 | 음성 인터페이스 | 텍스트 기반만 지원 |
| OS-002 | 금융 거래 | 조회만 가능, 실제 거래 불가 |
| OS-003 | iCloud 캘린더 | Google Calendar만 지원 |

---

## 1.3 정의, 약어 및 용어

### 1.3.1 용어 정의

| 용어 | 정의 |
|------|------|
| 자율 판단 (Autonomous Decision) | 사전 정의된 규칙 없이 LLM이 상황을 분석하여 스스로 행동을 결정하는 것 |
| 능동적 알림 (Proactive Notification) | 사용자 요청 없이 시스템이 먼저 제공하는 정보나 알림 |
| 반성 (Reflection) | 행동의 결과를 분석하고 교훈을 추출하는 프로세스 |
| 노드 (Node) | 에이전트 그래프에서 특정 기능을 수행하는 단위 |
| 상태 (State) | 에이전트가 판단에 사용하는 현재 컨텍스트 정보 |
| 교훈 (Lesson) | 과거 행동에서 학습한 규칙 또는 패턴 |

### 1.3.2 약어

| 약어 | 전체 명칭 |
|------|----------|
| LLM | Large Language Model |
| SRS | Software Requirements Specification |
| API | Application Programming Interface |
| UI | User Interface |
| DB | Database |
| RPM | Requests Per Minute |
| TPM | Tokens Per Minute |

---

## 1.4 참고 문서 (References)

| 문서 ID | 문서명 | 버전 | 비고 |
|---------|--------|------|------|
| REF-001 | IEEE 830-1998 | - | SRS 작성 표준 |
| REF-002 | ISO/IEC/IEEE 29148:2018 | - | 요구사항 엔지니어링 표준 |
| REF-003 | PLAN_proactive_ai_assistant.md | 1.0 | 패니저 v1.0 구현 계획 |
| REF-004 | LangGraph Documentation | - | 그래프 기반 에이전트 프레임워크 |
| REF-005 | Groq API Documentation | - | LLM API 문서 |

---

## 1.5 개요 (Overview)

본 문서는 IEEE 830 표준을 기반으로 다음과 같이 구성됩니다:

- **제2장**: 시스템의 전체적인 관점, 기능, 사용자, 제약사항 설명
- **제3장**: 상세 기능/비기능 요구사항 정의
- **제4장**: 요구사항 검증 방법 및 추적 매트릭스
- **제5장**: 부록 (프롬프트 템플릿, 데이터 모델 등)

---

# 2. 전체 설명 (Overall Description)

## 2.1 제품 관점 (Product Perspective)

### 2.1.1 시스템 컨텍스트

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            시스템 컨텍스트 (v3.0)                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌──────────┐                                      ┌──────────────┐       │
│   │  사용자   │◀────── Slack ──────────────────────▶│   패니저     │       │
│   └──────────┘                                      │   v3.0       │       │
│                                                      │              │       │
│   ┌────────────────┐                                │  ┌────────┐  │       │
│   │ Google         │──── Webhook ────────────────▶ │  │ LLM    │  │       │
│   │ Calendar       │  (일정 변경 시)                │  │ (Groq) │  │       │
│   └────────────────┘                                │  └────────┘  │       │
│                                                      │              │       │
│   ┌──────────────────────────────────────────────────┤  ┌────────┐  │       │
│   │                                                  │  │ Memory │  │       │
│   │  ┌────────────┐  ┌────────────┐  ┌───────────┐  │  │ SQLite │  │       │
│   │  │ 기상청 API  │  │ Kakao Maps │  │ ODsay API │  │  └────────┘  │       │
│   │  │ (날씨)      │  │ (자동차)    │  │ (대중교통) │  │              │       │
│   │  └────────────┘  └────────────┘  └───────────┘  │              │       │
│   │                                                  │              │       │
│   └──────────────────────────────────────────────────┴──────────────┘       │
│                                                                             │
│                             외부 서비스 인터페이스                           │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```


### 2.1.2 기존 시스템과의 관계

| 시스템 | 관계 | 설명 |
|--------|------|------|
| 패니저 v1.0 | 대체 | Rule-based → Autonomous 전환 |
| 패니저 v2.0 | 대체 | Polling → Event-driven 전환 |
| Slack | 통합 유지 | 기존 Slack 연동 유지 |
| SQLite DB | 확장 | 캘린더 동기화, 알림 스케줄 테이블 추가 |
| Google Calendar | 신규 | Webhook 기반 연동 |

### 2.1.3 운영 환경

| 구분 | 상세 |
|------|------|
| 서버 | HP T620 (Ubuntu 24.04) |
| 런타임 | Python 3.11+ |
| 컨테이너 | Docker + docker-compose |
| LLM | Groq (llama-3.1-70b-versatile) |
| 데이터베이스 | SQLite 3 |

---

## 2.2 제품 기능 요약 (Product Functions)

### 2.2.1 핵심 기능 맵

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           패니저 v2.0 기능 맵                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────┐      │
│   │                    자율 판단 엔진 (Core)                        │      │
│   │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐       │      │
│   │  │ Observe  │─▶│  Think   │─▶│   Act    │─▶│ Reflect  │       │      │
│   │  │ (관찰)   │  │  (판단)  │  │  (행동)  │  │  (반성)  │       │      │
│   │  └──────────┘  └──────────┘  └──────────┘  └──────────┘       │      │
│   └─────────────────────────────────────────────────────────────────┘      │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────┐      │
│   │                       도구 (Tools)                              │      │
│   │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐       │      │
│   │  │  날씨    │  │  일정    │  │ 길찾기   │  │ (확장)   │       │      │
│   │  └──────────┘  └──────────┘  └──────────┘  └──────────┘       │      │
│   └─────────────────────────────────────────────────────────────────┘      │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────┐      │
│   │                     인터페이스                                   │      │
│   │  ┌──────────┐  ┌──────────┐                                    │      │
│   │  │  Slack   │  │ (미래)   │                                    │      │
│   │  │  Bot     │  │ Web/App  │                                    │      │
│   │  └──────────┘  └──────────┘                                    │      │
│   └─────────────────────────────────────────────────────────────────┘      │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────┐      │
│   │                       메모리                                     │      │
│   │  ┌──────────┐  ┌──────────┐  ┌──────────┐                      │      │
│   │  │ 대화기록 │  │ 판단이력 │  │  교훈    │                      │      │
│   │  └──────────┘  └──────────┘  └──────────┘                      │      │
│   └─────────────────────────────────────────────────────────────────┘      │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.2.2 기능 목록

| ID | 기능명 | 설명 | 우선순위 |
|----|--------|------|----------|
| F-001 | 자율 판단 루프 | 주기적으로 상황을 분석하고 행동 여부 결정 | Critical |
| F-002 | 상황 관찰 | 시간, 날씨, 일정 등 현재 상태 수집 | Critical |
| F-003 | LLM 기반 판단 | Groq LLM으로 행동 필요 여부 결정 | Critical |
| F-004 | 행동 실행 | 알림 전송, 리마인더 설정 등 | Critical |
| F-005 | 반성 및 학습 | 행동 결과 분석, 교훈 저장 | Critical |
| F-006 | 교훈 기반 의사결정 | 과거 교훈을 판단에 반영 | High |
| F-007 | 날씨 도구 | 날씨 정보 조회 및 판단 | High |
| F-008 | 일정 도구 | 일정 CRUD 및 리마인더 | High |
| F-009 | 길찾기 도구 | 경로 검색 및 출발시간 계산 | Medium |
| F-010 | Slack 대화 | 사용자와 양방향 대화 | High |
| F-011 | 능동적 알림 | 사용자 요청 없이 먼저 알림 | High |
| F-012 | 메모리 영속화 | 대화, 판단, 교훈 저장 | High |

---

## 2.3 사용자 특성 (User Characteristics)

### 2.3.1 사용자 페르소나

| 페르소나 | 개발자/얼리어답터 |
|----------|------------------|
| **이름** | 김개발 |
| **나이** | 30대 |
| **직업** | 소프트웨어 개발자 |
| **기술 수준** | 높음 |
| **사용 목적** | 일정 관리, 날씨 확인, 리마인더 |
| **기대** | 알아서 필요한 정보를 먼저 알려주는 비서 |
| **불만사항** | 매번 물어봐야 하는 기존 챗봇 |

### 2.3.2 사용자 요구사항

| ID | 요구사항 | 우선순위 |
|----|----------|----------|
| U-001 | 요청하지 않아도 필요한 정보를 먼저 알려줌 | Critical |
| U-002 | 불필요한 알림으로 방해하지 않음 | Critical |
| U-003 | 같은 실수를 반복하지 않음 | Critical |
| U-004 | 자연스러운 대화 | High |
| U-005 | 24시간 가용 | High |

---

## 2.4 제약사항 (Constraints)

### 2.4.1 기술적 제약

| ID | 제약사항 | 영향 | 대응 방안 |
|----|----------|------|----------|
| TC-001 | Groq 무료 tier 제한 | 30 RPM, 6000 TPM | 호출 최적화, 캐싱 |
| TC-002 | Groq 무료 tier 일일 제한 | 14,400 RPD | 5분 간격 판단 (288회/일) |
| TC-003 | SQLite 동시성 제한 | 쓰기 잠금 | WAL 모드 적용 |
| TC-004 | Slack Rate Limit | 1 msg/sec | 메시지 큐잉 |

### 2.4.2 비용 제약

| 항목 | 제약 | 비고 |
|------|------|------|
| LLM API | $0/월 | Groq 무료 tier 사용 |
| 서버 비용 | 전기료만 | 기존 HP T620 활용 |
| 외부 API | 무료 tier | 기상청, Kakao Maps, ODsay |

### 2.4.3 운영 제약

| ID | 제약사항 | 설명 |
|----|----------|------|
| OC-001 | 인터넷 필수 | Slack, LLM API, Google Calendar 접근 필요 |
| OC-002 | 한국어 우선 | 한국어 대화 및 알림 |

---

## 2.5 가정 및 의존성 (Assumptions and Dependencies)

### 2.5.1 가정사항

| ID | 가정 | 영향 (가정 실패 시) |
|----|------|---------------------|
| A-001 | Groq 무료 tier가 유지됨 | 다른 LLM으로 전환 필요 |
| A-002 | 사용자는 Slack을 주 메신저로 사용 | 다른 인터페이스 개발 필요 |
| A-003 | HP T620 서버가 24/7 가동 | 대체 서버 필요 |
| A-004 | 인터넷 연결이 안정적 | 오프라인 폴백 필요 |

### 2.5.2 외부 의존성

| ID | 의존 대상 | 용도 | 대체 방안 |
|----|----------|------|----------|
| D-001 | Groq API | LLM 추론 | OpenAI, Anthropic, Ollama (로컬) |
| D-002 | Slack API | 사용자 인터페이스 | Discord, Telegram |
| D-003 | 기상청 API | 날씨 정보 | OpenWeatherMap |
| D-004 | Kakao Maps API | 자동차 길찾기 | Naver Maps, Google Maps |
| D-005 | ODsay API | 대중교통 길찾기 | TMAP API |
| D-006 | Google Calendar API | 일정 연동 | - |

---

# 3. 상세 요구사항 (Specific Requirements)

## 3.1 외부 인터페이스 요구사항

### 3.1.1 사용자 인터페이스 (UI)

#### UI-001: Slack 대화 인터페이스

| 항목 | 내용 |
|------|------|
| **ID** | UI-001 |
| **명칭** | Slack 대화 인터페이스 |
| **설명** | Slack을 통한 사용자와 패니저 간 양방향 대화 |
| **입력** | 사용자 텍스트 메시지 |
| **출력** | AI 응답 메시지 |
| **형식** | 마크다운, 이모지 지원 |

**지원 채널**:
| 채널 유형 | 설명 | 패니저 반응 |
|-----------|------|-------------|
| DM (Direct Message) | 1:1 개인 대화 | 항상 응답 |
| @멘션 | 채널에서 호출 | 항상 응답 |
| 채널 메시지 | 일반 채널 메시지 | 모니터링만 (응답 안 함) |

**능동적 알림 형식**:
```
[알림 유형 아이콘] [제목]

[본문 내용]

[추가 정보 or 행동 제안]
```

예시:
```
☔ 우산 알림

오늘 오후 3시부터 비 예보가 있어요!
14시 강남역 미팅 전에 비가 올 수 있으니 우산 챙기세요.

🚇 지금 출발하시면 딱 맞게 도착해요!
```

---

### 3.1.2 하드웨어 인터페이스 (HI)

패니저 v2.0은 특별한 하드웨어 인터페이스가 필요하지 않습니다.

---

### 3.1.3 소프트웨어 인터페이스 (SI)

#### SI-001: LLM API (Groq)

| 항목 | 내용 |
|------|------|
| **ID** | SI-001 |
| **명칭** | Groq LLM API |
| **용도** | 자율 판단, 메시지 생성, 반성 |
| **프로토콜** | HTTPS REST API |
| **인증** | API Key (Bearer Token) |
| **모델** | llama-3.1-70b-versatile |

**요청 형식**:
```json
{
  "model": "llama-3.1-70b-versatile",
  "messages": [
    {"role": "system", "content": "..."},
    {"role": "user", "content": "..."}
  ],
  "temperature": 0.7,
  "max_tokens": 1024
}
```

**제한사항**:
| 제한 | 값 | 대응 |
|------|-----|------|
| RPM (분당 요청) | 30 | 2초 간격 이상 유지 |
| TPM (분당 토큰) | 6,000 | 프롬프트 최적화 |
| RPD (일일 요청) | 14,400 | 5분 간격 판단 |

---

#### SI-002: Slack API

| 항목 | 내용 |
|------|------|
| **ID** | SI-002 |
| **명칭** | Slack Bolt (Socket Mode) |
| **용도** | 메시지 수신/발신, 이벤트 처리 |
| **프로토콜** | WebSocket |
| **인증** | Bot Token (xoxb-), App Token (xapp-) |

**필요 권한 (Scopes)**:
| Scope | 용도 |
|-------|------|
| `chat:write` | 메시지 전송 |
| `im:history` | DM 기록 조회 |
| `im:read` | DM 읽기 |
| `im:write` | DM 쓰기 |
| `app_mentions:read` | 멘션 수신 |
| `channels:history` | 채널 기록 조회 |

---

#### SI-003: 기상청 단기예보 API

| 항목 | 내용 |
|------|------|
| **ID** | SI-003 |
| **명칭** | 기상청 단기예보 조회서비스 |
| **용도** | 현재 날씨 및 예보 조회 |
| **프로토콜** | HTTPS REST API |
| **제공처** | 공공데이터포털 (data.go.kr) |
| **무료 한도** | 무제한 (활용 신청 필요) |

**응답 데이터**:
| 필드 | 타입 | 설명 |
|------|------|------|
| TMP | string | 기온 (℃) |
| SKY | string | 하늘 상태 (1:맑음, 3:구름많음, 4:흐림) |
| PTY | string | 강수 형태 (0:없음, 1:비, 2:비/눈, 3:눈) |
| POP | string | 강수 확률 (%) |
| REH | string | 습도 (%) |

---

#### SI-004: Kakao Maps API

| 항목 | 내용 |
|------|------|
| **ID** | SI-004 |
| **명칭** | Kakao 길찾기 API |
| **용도** | 자동차 경로 검색, 소요시간 계산 |
| **프로토콜** | HTTPS REST API |
| **무료 한도** | 300,000 calls/day |

---

#### SI-005: ODsay API

| 항목 | 내용 |
|------|------|
| **ID** | SI-005 |
| **명칭** | ODsay 대중교통 길찾기 API |
| **용도** | 대중교통 경로 검색 (버스, 지하철, 환승) |
| **프로토콜** | HTTPS REST API |
| **무료 한도** | 1,000 calls/day |

**응답 데이터**:
| 필드 | 타입 | 설명 |
|------|------|------|
| pathType | int | 경로 유형 (1:지하철, 2:버스, 3:버스+지하철) |
| totalTime | int | 총 소요시간 (분) |
| payment | int | 요금 (원) |
| subwayTransitCount | int | 지하철 환승 횟수 |
| busTransitCount | int | 버스 환승 횟수 |
| totalWalkTime | int | 총 도보 시간 (분) |

---

#### SI-006: Google Calendar API

| 항목 | 내용 |
|------|------|
| **ID** | SI-006 |
| **명칭** | Google Calendar API + Push Notifications |
| **용도** | 일정 조회, 변경 Webhook 수신 |
| **프로토콜** | HTTPS REST API + Webhook |
| **인증** | OAuth 2.0 |

**Webhook 이벤트**:
| 이벤트 | 설명 |
|--------|------|
| calendar.events.created | 일정 생성 |
| calendar.events.updated | 일정 수정 |
| calendar.events.deleted | 일정 삭제 |

---

### 3.1.4 통신 인터페이스 (CI)

| ID | 프로토콜 | 용도 | 포트 |
|----|----------|------|------|
| CI-001 | HTTPS | 외부 API 통신 | 443 |
| CI-002 | WSS | Slack Socket Mode | 443 |
| CI-003 | HTTPS | Google Calendar Webhook 수신 | 8080 |


---

## 3.2 기능 요구사항 (Functional Requirements)

### 3.2.1 자율 판단 시스템 (FR-100)

#### FR-101: 상황 관찰 (Observe)

| 항목 | 내용 |
|------|------|
| **ID** | FR-101 |
| **명칭** | 상황 관찰 |
| **설명** | 현재 시간, 날씨, 일정, 최근 알림 등 상태 정보를 수집한다 |
| **우선순위** | Critical |
| **선행조건** | 시스템 가동 중 |
| **후행조건** | 상태 정보가 State 객체에 저장됨 |

**수집 정보**:
| 정보 | 소스 | 주기 |
|------|------|------|
| 현재 시간 | System Clock | 일정 이벤트 시 |
| 날씨 | 기상청 API | 30분 캐시 |
| 일정 | Google Calendar (로컬 DB 동기화) | Webhook 트리거 |
| 교통 정보 | Kakao/ODsay API | 일정 이벤트 시 |
| 최근 알림 | Memory | 일정 이벤트 시 |
| 학습 교훈 | SQLite DB | 일정 이벤트 시 |

**상태 스키마**:
```python
class AgentState(TypedDict):
    # 시간 정보
    current_time: datetime
    time_period: str  # morning, afternoon, evening, night
    day_of_week: str
    
    # 날씨 정보
    weather: WeatherData
    needs_umbrella: bool
    
    # 일정 정보
    today_schedules: list[Schedule]
    upcoming_schedule: Optional[Schedule]
    minutes_to_next: Optional[int]
    
    # 알림 이력
    last_notification_time: Optional[datetime]
    today_notification_count: int
    recent_notifications: list[Notification]
    
    # 학습 정보
    relevant_lessons: list[Lesson]
```

---

#### FR-102: 판단 (Think)

| 항목 | 내용 |
|------|------|
| **ID** | FR-102 |
| **명칭** | LLM 기반 판단 |
| **설명** | 수집된 상태 정보를 바탕으로 LLM이 행동 여부를 판단한다 |
| **우선순위** | Critical |
| **선행조건** | FR-101 완료 (상태 수집됨) |
| **후행조건** | 판단 결과(act/wait)가 결정됨 |

**판단 기준**:
1. 사용자에게 지금 당장 가치 있는 정보인가?
2. 이미 유사한 알림을 보냈는가? (중복 방지)
3. 방해가 되지 않는 시간대인가?
4. 과거 교훈에 위배되지 않는가?
5. 행동하지 않으면 사용자가 손해를 보는가?

**판단 결과 스키마**:
```python
class ThinkResult(BaseModel):
    reasoning: str  # 판단 과정 설명
    decision: Literal["act", "wait"]
    action: Optional[ActionDetail]
    confidence: float  # 0.0 ~ 1.0
```

**비즈니스 규칙**:
| 규칙 ID | 규칙 | 설명 |
|---------|------|------|
| BR-101-01 | confidence < 0.7 → wait | 확신 없으면 행동 안 함 |
| BR-101-02 | 2시간 내 동일 정보 재전송 금지 | 중복 알림 방지 |
| BR-101-03 | 23:00 ~ 07:00 긴급만 알림 | 방해 금지 시간 |
| BR-101-04 | 일일 최대 7회 알림 | 알림 피로 방지 |

---

#### FR-103: 행동 (Act)

| 항목 | 내용 |
|------|------|
| **ID** | FR-103 |
| **명칭** | 행동 실행 |
| **설명** | 판단 결과에 따라 알림 전송, 리마인더 설정 등을 수행한다 |
| **우선순위** | Critical |
| **선행조건** | FR-102에서 decision = "act" |
| **후행조건** | 행동이 실행되고 결과가 기록됨 |

**지원 액션 유형**:
| 액션 | 설명 | 예시 |
|------|------|------|
| notify | 즉시 알림 전송 | 우산 알림, 일정 리마인더 |
| schedule | 예약 알림 설정 | 30분 후 리마인더 |
| query | 정보 조회 | 날씨, 길찾기 조회 |

**액션 스키마**:
```python
class ActionDetail(BaseModel):
    type: Literal["notify", "schedule", "query"]
    message: str
    timing: Literal["now", "scheduled"]
    scheduled_time: Optional[datetime]
    tool: Optional[str]  # weather, calendar, directions
```

---

#### FR-104: 반성 (Reflect)

| 항목 | 내용 |
|------|------|
| **ID** | FR-104 |
| **명칭** | 행동 결과 반성 |
| **설명** | 실행된 행동의 결과를 분석하고 교훈을 추출한다 |
| **우선순위** | Critical |
| **선행조건** | FR-103 완료 (행동 실행됨) |
| **후행조건** | 교훈이 DB에 저장됨 (필요시) |

**반성 프로세스**:
1. 행동 결과 수집 (전송 성공 여부)
2. 사용자 반응 관찰 (5분 대기)
3. LLM으로 분석 및 교훈 추출
4. 교훈 저장 (부정적 반응 시)

**사용자 반응 유형**:
| 반응 | 판정 | 조치 |
|------|------|------|
| 대화 응답 | 긍정 | 기록만 |
| 무시 (미응답) | 중립/부정 | 교훈 후보 |
| "그만", "됐어" 등 | 부정 | 교훈 저장 |
| 감사 표현 | 긍정 | 패턴 강화 |

**교훈 스키마**:
```python
class Lesson(BaseModel):
    id: str
    created_at: datetime
    context: dict  # 상황 조건
    action_taken: str  # 수행한 행동
    user_reaction: str  # 사용자 반응
    lesson: LessonContent  # 교훈 내용
    importance: Literal["low", "medium", "high"]
    occurrences: int  # 발생 횟수
```

---

### 3.2.2 도구 시스템 (FR-200)

#### FR-201: 날씨 도구

| 항목 | 내용 |
|------|------|
| **ID** | FR-201 |
| **명칭** | 날씨 조회 도구 |
| **설명** | 지정된 도시의 현재 날씨와 예보를 조회한다 |
| **우선순위** | High |

**기능**:
| 함수 | 설명 | 입력 | 출력 |
|------|------|------|------|
| get_current_weather | 현재 날씨 조회 | city: str | WeatherData |
| check_umbrella | 우산 필요 여부 | city: str | bool |

---

#### FR-202: 일정 도구

| 항목 | 내용 |
|------|------|
| **ID** | FR-202 |
| **명칭** | 일정 관리 도구 |
| **설명** | 일정 CRUD 및 리마인더 기능을 제공한다 |
| **우선순위** | High |

**기능**:
| 함수 | 설명 | 입력 | 출력 |
|------|------|------|------|
| get_schedule | 특정 날짜 일정 조회 | date: str | list[Schedule] |
| add_schedule | 일정 추가 | title, time, location | Schedule |
| delete_schedule | 일정 삭제 | schedule_id: str | bool |
| get_upcoming | 다가오는 일정 | hours: int | list[Schedule] |

---

#### FR-203: 길찾기 도구

| 항목 | 내용 |
|------|------|
| **ID** | FR-203 |
| **명칭** | 길찾기 도구 |
| **설명** | 대중교통 경로와 소요시간을 계산한다 |
| **우선순위** | Medium |

**기능**:
| 함수 | 설명 | 입력 | 출력 |
|------|------|------|------|
| get_directions | 경로 검색 | origin, destination | DirectionsData |
| calculate_departure | 출발시간 역산 | destination, arrival_time | datetime |

---

### 3.2.3 메모리 시스템 (FR-300)

#### FR-301: 대화 기록 저장

| 항목 | 내용 |
|------|------|
| **ID** | FR-301 |
| **명칭** | 대화 기록 저장 |
| **설명** | 사용자와의 대화 내용을 저장하여 맥락 유지 |
| **우선순위** | High |
| **보존 기간** | 30일 |

---

#### FR-302: 판단 이력 저장

| 항목 | 내용 |
|------|------|
| **ID** | FR-302 |
| **명칭** | 판단 이력 저장 |
| **설명** | 모든 판단 과정과 결과를 저장 |
| **우선순위** | High |
| **보존 기간** | 90일 |

---

#### FR-303: 학습 교훈 저장

| 항목 | 내용 |
|------|------|
| **ID** | FR-303 |
| **명칭** | 학습 교훈 저장 |
| **설명** | 반성을 통해 얻은 교훈을 영구 저장 |
| **우선순위** | Critical |
| **보존 기간** | 영구 |

---

### 3.2.4 이벤트 기반 스케줄링 시스템 (FR-350) 🆕

> **v3.0 핵심 기능**: 폴링 방식 대신 Google Calendar Webhook을 통해 일정 변경 시 즉시 알림 스케줄을 생성합니다.

#### FR-351: 캘린더 Webhook 수신

| 항목 | 내용 |
|------|------|
| **ID** | FR-351 |
| **명칭** | Google Calendar Webhook 수신 |
| **설명** | 일정 생성/수정/삭제 시 Webhook을 수신하여 처리 |
| **우선순위** | Critical |
| **선행조건** | Google Calendar OAuth 연결됨 |
| **후행조건** | 로컬 DB에 일정 동기화됨, FR-352 트리거 |

---

#### FR-352: 캘린더 DB 동기화

| 항목 | 내용 |
|------|------|
| **ID** | FR-352 |
| **명칭** | 캘린더 로컬 DB 동기화 |
| **설명** | Google Calendar 일정을 로컬 DB에 저장하여 API 호출 최소화 |
| **우선순위** | Critical |

**DB 스키마**:
```sql
CREATE TABLE calendar_events (
    id TEXT PRIMARY KEY,
    google_event_id TEXT UNIQUE,
    user_id TEXT NOT NULL,
    title TEXT NOT NULL,
    start_time TIMESTAMP NOT NULL,
    end_time TIMESTAMP,
    location TEXT,
    description TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

---

#### FR-353: 교통편별 출발 시간 계산

| 항목 | 내용 |
|------|------|
| **ID** | FR-353 |
| **명칭** | 교통편별 출발 시간 계산 |
| **설명** | 일정 장소까지 자동차/대중교통/택시 경로별 소요시간 계산 |
| **우선순위** | Critical |

**계산 로직**:
1. 일정 장소(location) 추출
2. Kakao API로 자동차 경로 조회
3. ODsay API로 대중교통 경로 조회
4. 각 교통편별 권장 출발 시간 계산
5. 가장 빠른 출발 시간 기준으로 알림 시간 결정

**응답 예시**:
```python
{
    "car": {"duration": 40, "departure_time": "13:20"},
    "transit": {"duration": 55, "transfers": 1, "departure_time": "13:05"},
    "taxi": {"duration": 35, "departure_time": "13:25"},
    "recommended_alert_time": "13:00"  # 가장 빠른 출발 시간 5분 전
}
```

---

#### FR-354: 알림 스케줄 생성

| 항목 | 내용 |
|------|------|
| **ID** | FR-354 |
| **명칭** | 알림 스케줄 자동 생성 |
| **설명** | LLM이 일정별 최적 알림 시간을 결정하고 스케줄 등록 |
| **우선순위** | Critical |

**DB 스키마**:
```sql
CREATE TABLE notification_schedules (
    id TEXT PRIMARY KEY,
    user_id TEXT NOT NULL,
    event_id TEXT NOT NULL,
    scheduled_time TIMESTAMP NOT NULL,
    message TEXT NOT NULL,
    transport_options TEXT,  -- JSON: 교통편별 정보
    weather_info TEXT,       -- JSON: 날씨 정보
    status TEXT DEFAULT 'pending',  -- pending, sent, cancelled
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (event_id) REFERENCES calendar_events(id)
);
```

**스케줄 저장 방식**: 
- SQLite DB에 영구 저장 (재시작 시 복원)
- APScheduler에 실행 등록

---

#### FR-355: 알림 메시지 생성

| 항목 | 내용 |
|------|------|
| **ID** | FR-355 |
| **명칭** | 알림 메시지 생성 |
| **설명** | 교통편별 출발 시간, 날씨 정보를 포함한 알림 생성 |
| **우선순위** | High |

**알림 형식**:
```
📅 {시간} {일정 제목} 알림

{날씨 정보가 있으면}
☔ {날씨 경고 메시지}

🚗 자가용: {소요시간}분 ({출발시간} 출발 권장)
🚇 지하철: {소요시간}분, 환승 {N}회 ({출발시간} 출발 권장)
🚕 택시: {소요시간}분 ({출발시간} 출발 권장)

현재 교통 상황: {정체/원활}
```

---

#### FR-356: 무응답 시 재알림

| 항목 | 내용 |
|------|------|
| **ID** | FR-356 |
| **명칭** | 무응답 시 재알림 |
| **설명** | 사용자가 알림에 응답하지 않으면 재알림 (주기는 LLM 판단) |
| **우선순위** | High |

**재알림 로직**:
1. 알림 전송 후 5분간 사용자 반응 대기
2. 무응답 시 LLM이 재알림 필요 여부 판단
3. 필요시 재알림 스케줄 등록 (보통 10-15분 후)
4. 일정 시작 시간 이후에는 재알림 중단

---

### 3.2.5 대화 시스템 (FR-400)

#### FR-401: 자연어 대화

| 항목 | 내용 |
|------|------|
| **ID** | FR-401 |
| **명칭** | 자연어 대화 처리 |
| **설명** | 사용자의 자연어 입력을 이해하고 적절히 응답 |
| **우선순위** | High |

**대화 흐름**:
1. 사용자 메시지 수신 (Slack)
2. 메시지 의도 분석 (LLM)
3. 필요시 도구 호출
4. 응답 생성 (LLM)
5. Slack으로 응답 전송

---

#### FR-402: 능동적 알림

| 항목 | 내용 |
|------|------|
| **ID** | FR-402 |
| **명칭** | 능동적 알림 |
| **설명** | 사용자 요청 없이 시스템이 먼저 정보 제공 |
| **우선순위** | Critical |

**알림 트리거 예시**:
| 상황 | 알림 내용 |
|------|----------|
| 외출 일정 + 비 예보 | 우산 챙기세요! |
| 일정 30분 전 | 곧 일정이 있어요! |
| 원거리 일정 | 지금 출발하세요! |
| 날씨 급변 | 날씨가 바뀌었어요! |

---

## 3.3 비기능 요구사항 (Non-Functional Requirements)

### 3.3.1 성능 요구사항 (NFR-100)

#### NFR-101: 응답 시간

| 항목 | 목표 | 측정 방법 |
|------|------|----------|
| 대화 응답 시간 | < 5초 (p95) | 메시지 수신 → 응답 전송 |
| 판단 루프 시간 | < 10초 | Observe → Think 완료 |
| 능동적 알림 지연 | < 1분 | 이벤트 감지 → 알림 전송 |

#### NFR-102: 처리량

| 항목 | 목표 |
|------|------|
| 동시 대화 | 다중 사용자 지원 |
| 일일 판단 횟수 | 이벤트 기반 (일정 변경 시) |
| 일일 LLM 호출 | < 100회 (이벤트 기반으로 최소화) |

---

### 3.3.2 신뢰성 요구사항 (NFR-200)

#### NFR-201: 가용성

| 항목 | 목표 |
|------|------|
| 목표 가용성 | 99% (월 7시간 다운타임 허용) |
| 계획된 유지보수 | 월 1회, 30분 이내 |
| 자동 복구 시간 | 5분 이내 |

#### NFR-202: 오류 처리

| 오류 유형 | 대응 |
|-----------|------|
| LLM API 실패 | 폴백 응답 또는 재시도 |
| 외부 API 실패 | 캐시 데이터 사용 또는 생략 |
| DB 오류 | 로그 기록 및 메모리 모드 전환 |

---

### 3.3.3 보안 요구사항 (NFR-300)

#### NFR-301: 데이터 보호

| 항목 | 요구사항 |
|------|----------|
| API 키 저장 | 환경 변수 또는 시크릿 매니저 |
| 파일 권한 | .env 파일 600 권한 |
| DB 접근 | 로컬 파일 (외부 노출 없음) |

#### NFR-302: 통신 보안

| 항목 | 요구사항 |
|------|----------|
| 외부 API 통신 | HTTPS 필수 |
| Slack 연결 | WSS (WebSocket Secure) |

---

### 3.3.4 유지보수성 요구사항 (NFR-400)

#### NFR-401: 코드 품질

| 항목 | 목표 |
|------|------|
| 테스트 커버리지 | ≥ 75% |
| 린트 통과 | ruff, black 100% |
| 타입 체크 | mypy 통과 |

#### NFR-402: 로깅

| 로그 레벨 | 용도 |
|-----------|------|
| DEBUG | 상세 판단 과정 |
| INFO | 주요 이벤트 (알림 전송, 판단 결과) |
| WARNING | 경고 (API 지연, 재시도) |
| ERROR | 오류 (API 실패, 예외) |

---

## 3.4 시스템 속성 (System Attributes)

### 3.4.1 확장성 (Extensibility)

**새 도구 추가 절차**:
1. `src/core/tools/plugins/`에 새 도구 클래스 생성
2. `BaseTool` 상속 및 `execute()` 구현
3. 도구 설명(description) 작성 (LLM이 이해할 수 있도록)
4. Registry에 자동 등록

**목표**: 새 도구 추가 시 코드 변경 50줄 미만

---

### 3.4.2 이식성 (Portability)

| 환경 | 지원 |
|------|------|
| Ubuntu 24.04 | ✅ 주요 |
| macOS | ✅ 개발 |
| Windows WSL | ✅ 개발 |
| Docker | ✅ 프로덕션 |

---

# 4. 검증 (Verification)

## 4.1 검증 방법

| 요구사항 유형 | 검증 방법 |
|--------------|----------|
| 기능 요구사항 | 단위 테스트, 통합 테스트, E2E 테스트 |
| 성능 요구사항 | 성능 테스트, 로드 테스트 |
| 신뢰성 요구사항 | 장애 주입 테스트, 모니터링 |
| 보안 요구사항 | 보안 점검, 코드 리뷰 |

---

## 4.2 요구사항 추적 매트릭스 (RTM)

| 요구사항 ID | 테스트 케이스 ID | 검증 상태 |
|-------------|-----------------|----------|
| FR-101 | TC-101-01, TC-101-02 | ⏳ |
| FR-102 | TC-102-01 ~ TC-102-05 | ⏳ |
| FR-103 | TC-103-01 ~ TC-103-03 | ⏳ |
| FR-104 | TC-104-01 ~ TC-104-04 | ⏳ |
| FR-201 | TC-201-01, TC-201-02 | ⏳ |
| FR-202 | TC-202-01 ~ TC-202-04 | ⏳ |
| FR-203 | TC-203-01, TC-203-02 | ⏳ |
| NFR-101 | PT-101-01 | ⏳ |
| NFR-201 | RT-201-01 | ⏳ |

---

## 4.3 테스트 시나리오

### TC-102-01: 아침 비 예보 + 외출 일정

**시나리오**: 
- 시간: 07:30
- 날씨: 오전 10시부터 비 예보
- 일정: 10:00 강남역 미팅

**기대 결과**:
- decision: "act"
- action.type: "notify"
- message: 우산 관련 알림

### TC-102-02: 이미 알림 보낸 직후

**시나리오**:
- 동일 조건
- 단, 15분 전에 동일 알림 전송됨

**기대 결과**:
- decision: "wait"
- reasoning: 중복 알림 방지

### TC-104-01: 사용자 부정적 반응 시 학습

**시나리오**:
- 알림 전송 후 사용자가 "됐어"라고 응답

**기대 결과**:
- 교훈 저장됨
- 다음 유사 상황에서 교훈 참조됨

---

# 5. 부록 (Appendices)

## 5.1 프롬프트 템플릿

### 5.1.1 THINK 프롬프트

```
# 역할
당신은 능동적 AI 비서 "패니저"의 판단 엔진입니다.
사용자가 요청하기 전에 먼저 필요한 것을 제공하는 것이 목표입니다.

# 현재 상황
{state_yaml}

# 과거에서 배운 교훈 (⚠️ 반드시 준수)
{lessons}

# 판단 기준
1. 사용자가 "지금 당장" 이 정보를 알면 도움이 되는가?
2. 이미 비슷한 알림을 보냈는가? (중복 방지)
3. 방해가 되지 않는 시간인가?
4. 과거 교훈에 위배되지 않는가?
5. 행동하지 않으면 사용자가 손해를 보는가?

# 응답 형식 (JSON)
{response_schema}

# 중요 규칙
- 확신이 없으면 "wait" 선택
- confidence가 0.7 미만이면 반드시 "wait"
- 같은 정보를 2시간 내 재전송 금지
```

### 5.1.2 REFLECT 프롬프트

```
# 역할
당신은 방금 일어난 행동의 결과를 분석하고 교훈을 추출하는 역할입니다.

# 방금 일어난 일
{action_result_yaml}

# 분석 기준
1. 사용자가 이 알림을 유용하게 여겼는가?
2. 타이밍이 적절했는가?
3. 내용이 충분했는가, 과했는가?
4. 무엇을 다르게 했어야 하는가?

# 응답 형식 (JSON)
{response_schema}

# 교훈 저장 기준
- 사용자가 부정적 반응을 보인 경우 → 반드시 저장
- 같은 실수가 반복되면 → 중요도 상향
```

---

## 5.2 데이터베이스 스키마

### 5.2.1 lessons 테이블

```sql
CREATE TABLE lessons (
    id TEXT PRIMARY KEY,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    context_json TEXT NOT NULL,
    action_taken TEXT NOT NULL,
    user_reaction TEXT NOT NULL,
    lesson_condition TEXT NOT NULL,
    lesson_should TEXT NOT NULL,
    lesson_should_not TEXT NOT NULL,
    importance TEXT CHECK(importance IN ('low', 'medium', 'high')),
    occurrences INTEGER DEFAULT 1,
    last_occurred TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 5.2.2 decisions 테이블

```sql
CREATE TABLE decisions (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    state_json TEXT NOT NULL,
    reasoning TEXT NOT NULL,
    decision TEXT CHECK(decision IN ('act', 'wait')),
    action_json TEXT,
    confidence REAL,
    executed BOOLEAN DEFAULT FALSE,
    user_reaction TEXT
);
```

---

## 5.3 용어 사전 (Glossary)

| 용어 | 정의 |
|------|------|
| 에이전트 | 자율적으로 판단하고 행동하는 AI 시스템 |
| 노드 | 에이전트 그래프에서 특정 역할을 수행하는 단위 |
| 상태 | 에이전트가 판단에 사용하는 현재 컨텍스트 정보 |
| 교훈 | 과거 행동에서 학습한 규칙 또는 패턴 |
| 도구 | 에이전트가 외부와 상호작용하기 위한 기능 |

---

## 5.4 승인

| 역할 | 이름 | 서명 | 날짜 |
|------|------|------|------|
| 작성자 | | | |
| 검토자 | | | |
| 승인자 | | | |

---

**문서 끝**
