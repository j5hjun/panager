name: Deploy

on:
  push:
    branches:
      - main
    paths-ignore:
      - 'docs/**'
      - '**/*.md'
      - '.github/workflows/ci.yml'

env:
  REGISTRY: ghcr.io

jobs:
  build:
    name: Build & Push
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      image_name: ${{ steps.lower.outputs.name }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Lowercase image name
        id: lower
        run: echo "name=$(echo '${{ env.REGISTRY }}/${{ github.repository }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ steps.lower.outputs.name }}:${{ github.sha }}
            ${{ steps.lower.outputs.name }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    name: Deploy to Server
    needs: build
    runs-on: self-hosted
    environment: production
    concurrency:
      group: production
      cancel-in-progress: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Create .env file
        run: |
          echo "${{ secrets.ENV_FILE }}" > .env
          chmod 600 .env

      - name: Backup current version
        id: backup
        run: |
          CURRENT=$(docker inspect panager --format='{{.Config.Image}}' 2>/dev/null | cut -d: -f2 || echo "none")
          echo "current_tag=$CURRENT" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ Current version: $CURRENT"

      - name: Pull new image
        env:
          IMAGE_TAG: ${{ github.sha }}
        run: |
          echo "ğŸ“¥ Pulling image: ${{ needs.build.outputs.image_name }}:${{ github.sha }}"
          docker compose pull

      - name: Deploy new version
        id: deploy
        env:
          IMAGE_TAG: ${{ github.sha }}
        run: |
          echo "ğŸš€ Deploying version: ${{ github.sha }}"
          docker compose up -d --force-recreate --wait --wait-timeout 120
          echo "âœ… Deployment successful!"

      - name: Verify health
        if: success()
        run: |
          echo "ğŸ¥ Verifying health..."
          sleep 5
          curl -sf http://localhost:8000/health || (echo "âŒ Health check failed" && exit 1)
          echo "âœ… Health check passed!"

      - name: Show logs on failure
        if: failure()
        run: |
          echo "âŒ Deployment failed. Container logs:"
          docker compose logs --tail=100

      - name: Rollback on failure
        if: failure() && steps.backup.outputs.current_tag != 'none'
        env:
          IMAGE_TAG: ${{ steps.backup.outputs.current_tag }}
        run: |
          echo "âš ï¸ Rolling back to: ${{ steps.backup.outputs.current_tag }}"
          docker compose pull || true
          docker compose up -d --force-recreate

      - name: Cleanup unused images
        if: always()
        run: docker image prune -f
