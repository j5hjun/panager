name: Deploy

on:
  workflow_run:
    workflows: ["Docker Build"]
    types:
      - completed
    branches: [ main ]

jobs:
  deploy:
    runs-on: self-hosted
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Create .env file
      run: |
        echo "${{ secrets.ENV_FILE }}" > .env
        chmod 600 .env
    
    # 다운타임 최소화: 새 이미지 pull (서비스 계속 실행 중)
    - name: Pull latest image
      run: docker compose pull
    
    # 빠르게 컨테이너 교체
    - name: Deploy with minimal downtime
      run: docker compose up -d --wait
    
    - name: Check deployment status
      run: |
        docker compose ps
        docker compose logs --tail=30
    
    - name: Health check
      run: |
        if docker compose ps | grep -qE "(Up|running|healthy)"; then
          echo "✅ 배포 성공!"
        else
          echo "❌ 배포 실패"
          docker compose ps
          exit 1
        fi
    
    # 사용하지 않는 이전 이미지 정리
    - name: Cleanup old images
      run: docker image prune -f
