name: Deploy

on:
  push:
    branches:
      - main
    paths-ignore:
      - 'docs/**'
      - '**/*.md'
      - '.github/workflows/ci.yml'

jobs:
  deploy:
    name: Build & Deploy
    runs-on: self-hosted
    environment: production
    concurrency:
      group: production
      cancel-in-progress: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create .env file
        run: |
          echo "${{ secrets.ENV_FILE }}" > .env
          chmod 600 .env

      - name: Build Image Locally
        env:
          IMAGE_TAG: ${{ github.sha }}
        run: |
          echo "ğŸ”¨ Building image locally (Leveraging Cache)..."
          docker build \
            -t ghcr.io/${{ github.repository }}:${{ github.sha }} \
            -t ghcr.io/${{ github.repository }}:latest \
            .

      - name: Backup current version
        id: backup
        run: |
          # í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ ì»¨í…Œì´ë„ˆì˜ ì´ë¯¸ì§€ í•´ì‹œ/íƒœê·¸ í™•ì¸
          CURRENT=$(docker inspect panager --format='{{.Config.Image}}' 2>/dev/null | cut -d: -f2 || echo "none")
          echo "current_tag=$CURRENT" >> $GITHUB_OUTPUT

      - name: Run DB Migrations
        env:
          IMAGE_TAG: ${{ github.sha }}
        run: |
          echo "ğŸ”„ Running database migrations..."
          docker compose run --rm app alembic upgrade head

      - name: Deploy new version
        id: deploy
        env:
          IMAGE_TAG: ${{ github.sha }}
        run: |
          echo "ğŸš€ Deploying version: ${{ github.sha }}"
          docker compose up -d --force-recreate --wait --wait-timeout 120
          echo "âœ… Deployment successful!"

      - name: Verify health
        if: success()
        run: |
          echo "ğŸ¥ Verifying health..."
          sleep 5
          curl -sf http://localhost:8000/health || (echo "âŒ Health check failed" && exit 1)
          echo "âœ… Health check passed!"

      - name: Show logs on failure
        if: failure()
        run: |
          echo "âŒ Deployment failed. Container logs:"
          docker compose logs --tail=100

      - name: Rollback on failure
        if: failure() && steps.backup.outputs.current_tag != 'none'
        env:
          IMAGE_TAG: ${{ steps.backup.outputs.current_tag }}
        run: |
          echo "âš ï¸ Rolling back to: ${{ steps.backup.outputs.current_tag }}"
          docker compose up -d --force-recreate

      - name: Cleanup unused images
        if: always()
        run: |
          echo "ğŸ§¹ Cleaning up..."
          docker image prune -f
